{"createdAt":"2025-09-10T04:49:01.704Z","updatedAt":"2025-09-19T03:57:32.802Z","id":"X6gxBfOGBA3PB9Wb","name":"32.농림축산식품부","active":true,"isArchived":false,"nodes":[{"parameters":{"url":"=https://www.mafra.go.kr/home/5108/subview.do","responseFormat":"string","options":{}},"name":"board list1","type":"n8n-nodes-base.httpRequest","position":[-3728,1104],"typeVersion":1,"id":"5109d3d4-5c93-4b07-a24c-15e433ed6a1d","alwaysOutputData":false,"notesInFlow":true,"executeOnce":false,"retryOnFail":false,"maxTries":5,"onError":"continueErrorOutput"},{"parameters":{"options":{"reset":"={{ $node[\"Loop Over Items\"].context[\"done\"] }}"}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-2960,1104],"id":"9fe1934a-0717-4e14-942e-230e792beebd","name":"Loop Over Items"},{"parameters":{"extractionValues":{"values":[{"key":"attach_file_name","cssSelector":".file_list > ul:nth-child(1) > li:nth-child(1) > a:nth-child(1)"},{"key":"attach_file_address","cssSelector":".file_list > ul:nth-child(1) > li:nth-child(1) > a:nth-child(1)","returnValue":"attribute","attribute":"href"},{"key":"content","cssSelector":".view_contents","returnValue":"html"}]},"options":{"trimValues":false}},"name":"리스트 추출3","type":"n8n-nodes-base.htmlExtract","position":[-1904,1104],"typeVersion":1,"id":"d873e07b-29af-47d9-b3cc-519e25f108f7"},{"parameters":{"assignments":{"assignments":[{"id":"dca754ac-4479-4295-ab21-47d895f62cae","name":"pblanc_nm","value":"={{ $('중복 자료 조회1').item.json.title }}","type":"string"},{"id":"0f927bf2-d7a7-4973-aac7-2717bed23371","name":"=jrsd_instt_nm","value":"=전지역","type":"string"},{"id":"8d6fa575-7d4d-44d6-aaf8-9f967d478af6","name":"bsns_sumry_cn","value":"={{ $json.content }}","type":"string"},{"id":"aff536ed-a418-4150-b586-d8f02a29010a","name":"is_classified","value":"H","type":"string"},{"id":"f03bb8b7-ece4-439f-9c91-8eb2b09a9aae","name":"source","value":"농림축산부","type":"string"},{"id":"70c059fa-5291-4b8a-920d-da0e2bb429a8","name":"del_yn","value":"N","type":"string"},{"id":"4851c2dc-8cec-417d-9243-66fce0c622d7","name":"hide_yn","value":"Y","type":"string"},{"id":"27d13c5d-61a2-4bbd-a774-5d43c70cfe02","name":"pldir_sport_realm_lclas_code_nm","value":"기술","type":"string"},{"id":"8e5587d7-89e5-4f54-96a4-ef827461ddf1","name":"creat_p_nttm","value":"={{ $json.creat_p_nttm }}","type":"string"},{"id":"7ad39a2b-787b-4e1c-92e8-47daa5ff1e66","name":"created_ts","value":"={{ $json.created_ts }}","type":"string"},{"id":"d09df1df-d892-4c7b-b701-773d0d85206e","name":"pblanc_url","value":"=https://www.mafra.go.kr/home/5108/subview.do","type":"string"},{"id":"c591abc7-b41e-49de-aa74-1836a55d5659","name":"exc_instt_nm","value":"=농림축산부","type":"string"},{"id":"23dda3dc-82ed-4bb2-97bc-44530a34ea22","name":"flpth_nm","value":"={{ $json.fileAddress }}","type":"string"},{"id":"7bfeb38f-9fdd-4aa7-a67d-9755a00f8488","name":"file_nm","value":"={{ $json.fileName }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1504,1104],"id":"fa67d078-86a6-4b3f-b4ba-bb158a218e97","name":"ai result"},{"parameters":{"operation":"upsert","table":{"__rl":true,"value":"biz_info","mode":"list","cachedResultName":"biz_info"},"columnToMatchOn":"pblanc_nm","options":{"detailedOutput":true}},"type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-1120,1104],"id":"f25c06e4-df6b-43ac-9685-572cd53ec210","name":"MySQL","retryOnFail":true,"credentials":{"mySql":{"id":"HSXhV0YEF0PlSVWX","name":"MySQL account"}},"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"amount":10,"unit":"seconds"},"id":"0d99cde5-b530-48d7-88b8-d07d232d652f","name":"Wait","type":"n8n-nodes-base.wait","typeVersion":1,"position":[-560,1120],"webhookId":"f4e67290-2925-4dcb-bd57-eb3c6ae36f58"},{"parameters":{"jsCode":"const items = $input.all();\n\nconst announcements = items[0]?.json?.announcements || [];\nconst titles = items[0]?.json?.title || [];\nconst dates = items[0]?.json?.date || [];\n\n// -------------------- 어제 날짜 계산 --------------------\nconst yesterday = new Date();\nyesterday.setDate(yesterday.getDate() - 1);\nconst yyyy = yesterday.getFullYear();\nconst mm = String(yesterday.getMonth() + 1).padStart(2, '0');\nconst dd = String(yesterday.getDate()).padStart(2, '0');\nlet yesterdayStr = `${yyyy}-${mm}-${dd}`;   // 자동 계산된 어제 날짜\n// ------------------------------------------------------\n\n// -------------------- 테스트용 날짜 지정 --------------------\n// 필요 시 아래 주석 해제 후 원하는 날짜로 테스트 가능\n// let yesterdayStr = '2025-09-10';  \n// ------------------------------------------------------\n\n// -------------------- 결과 생성 --------------------\nconst baseUrl = \"https://www.mafra.go.kr\";\n\nconst result = announcements\n  .map((announcement, index) => {\n    // 날짜 문자열 정리: \"2025.09.09\" → \"2025-09-09\"\n    let dateStr = dates[index] || null;\n    if (dateStr) {\n        dateStr = dateStr.replace(/등록일|\\\\n/g, '').trim(); // \"등록일\"과 \\n 제거\n        dateStr = dateStr.replace(/\\./g, '-');               // \".\" → \"-\"\n    }\n\n    // 제목 정리: \\t, 새글 제거\n    let cleanTitle = (titles[index] || '')\n      .replace(/\\t/g, '')        // 탭 제거\n      .replace(/새글/g, '')       // \"새글\" 제거\n      .replace(/[\\[\\]]/g, '')    // 대괄호 제거\n      .trim();\n\n    return {\n      json: {\n        announcement: `${baseUrl}${announcement}`,  // baseUrl + 원본 경로\n        title: cleanTitle,\n        date: dateStr\n      }\n    };\n  })\n  // -------------------- 어제 날짜만 필터 --------------------\n  .filter(item => item.json.date === yesterdayStr);\n\nreturn result;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3168,1104],"id":"7505dead-584c-43a0-af95-5b9317088fbf","name":"금일 기준1"},{"parameters":{"content":"사이트 주소\nhttps://www.mafra.go.kr/home/5108/subview.do","height":80,"width":660},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4256,992],"id":"13275bd3-6778-4482-bd57-70fcf6047c7e","name":"Sticky Note1"},{"parameters":{"jsCode":"let title = $input.first().json.title || '';\nlet announcement = $input.first().json.announcement\n\n// 괄호 또는 대괄호 안의 내용 제거\ntitle = title.replace(/[\\(\\[][^()\\[\\]]+[\\)\\]]/g, '').trim();\n\nreturn [\n  {\n    json: {\n      title,\n      announcement\n    }\n  }\n];\n\n\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2800,880],"id":"61ecbdb6-594d-47d8-a495-67a1caec0476","name":"중복 자료 조회1"},{"parameters":{"operation":"select","table":{"__rl":true,"value":"biz_info","mode":"list","cachedResultName":"biz_info"},"where":{"values":[{"column":"pblanc_nm","condition":"LIKE","value":"={{ $json.title }}"}]},"options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[-2656,880],"id":"d444ff22-706c-49a8-801f-c5f165e9167c","name":"중복조회 MYSQL1","alwaysOutputData":true,"credentials":{"mySql":{"id":"HSXhV0YEF0PlSVWX","name":"MySQL account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2d3aee72-46af-4378-99b4-a974ed6c6c5c","leftValue":"={{ $json.pblanc_nm }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2512,880],"id":"d8417791-2553-4e75-a445-58d644f7aadd","name":"중복조회 IF1"},{"parameters":{"extractionValues":{"values":[{"key":"announcements","cssSelector":".list > table:nth-child(1) > tbody:nth-child(4) > tr:nth-child(n) > td:nth-child(2) > p:nth-child(1) > a:nth-child(1)","returnValue":"attribute","attribute":"href","returnArray":true},{"key":"title","cssSelector":".list > table:nth-child(1) > tbody:nth-child(4) > tr:nth-child(n) > td:nth-child(2) > p:nth-child(1) > a:nth-child(1)","returnArray":true},{"key":"date","cssSelector":".list > table:nth-child(1) > tbody:nth-child(4) > tr:nth-child(n) > td:nth-child(2) > dl:nth-child(2) > dd:nth-child(2)","returnArray":true}]},"options":{"trimValues":true}},"name":"리스트 추출1","type":"n8n-nodes-base.htmlExtract","position":[-3472,1104],"typeVersion":1,"id":"ed42229a-b29b-4c97-820a-cf2653146bd2"},{"parameters":{"method":"POST","url":"=https://www.kesco.or.kr/bbs/selectBbs.do","sendBody":true,"bodyParameters":{"parameters":[{"name":"bbs_code","value":"MKB00001"},{"name":"bbs_seq","value":"={{ $('중복 자료 조회1').item.json.announcement }}"},{"name":"user_di"},{"name":"file_id"},{"name":"currentPage=1","value":"1"},{"name":"sch_type"},{"name":"sch_text"}]},"options":{"redirect":{"redirect":{"followRedirects":false}},"response":{"response":{"fullResponse":true,"neverError":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2256,592],"id":"1fb4bcf0-3558-4ce3-8d53-8a8d6dafb4f5","name":"set cookie1","onError":"continueRegularOutput"},{"parameters":{"jsCode":"return {\n  cookie: ($input.first().json.headers['set-cookie'] || []).join('; ')\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2080,592],"id":"3d23a9b2-9b89-42d8-b505-1bf37604c5fc","name":"get cookie1"},{"parameters":{"url":"={{ $('중복 자료 조회1').item.json.announcement }}","options":{"redirect":{"redirect":{"followRedirects":false}},"response":{"response":{"fullResponse":true,"neverError":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2192,1104],"id":"dcd3b464-2459-4cdc-b642-b49cef14d31a","name":"get detail","onError":"continueRegularOutput"},{"parameters":{"jsCode":"const nameRaw = $('리스트 추출3').first().json.attach_file_name || \"\";\nconst addressRaw = $('리스트 추출3').first().json.attach_file_address || \"\";\nconst contentRaw = $('리스트 추출3').first().json.content || \"\";\n\n// -------------------- 파일명 정리 --------------------\n// 공백/줄바꿈 제거\nconst cleanedName = nameRaw.replace(/[\\n\\r\\t]/g, \" \").trim();\n\n// 정규식으로 \"파일명.확장자\" 패턴 추출\nlet fileName = null;\nconst fileMatch = cleanedName.match(/[^\\/\\\\]+?\\.[a-zA-Z0-9]+/);\nif (fileMatch) {\n  fileName = fileMatch[0]; // 예: \"제30회 농업인의날 정부포상 추천 후보자 공개검증.pdf\"\n}\n\n// -------------------- 파일 주소 --------------------\nlet fileAddress = null;\nif (addressRaw) {\n  if (addressRaw.startsWith(\"http\")) {\n    fileAddress = addressRaw;\n  } else {\n    // 상대경로라면 baseUrl 붙이기\n    const baseUrl = \"https://www.mafra.go.kr\";\n    fileAddress = `${baseUrl}${addressRaw}`;\n  }\n}\n\n// -------------------- 생성일자 (KST 기준) --------------------\nconst now = new Date();\nconst kst = new Date(now.getTime() + 9 * 60 * 60 * 1000);\n\nconst yyyy = kst.getFullYear();\nconst mm = String(kst.getMonth() + 1).padStart(2, '0');\nconst dd = String(kst.getDate()).padStart(2, '0');\nconst hh = String(kst.getHours()).padStart(2, '0');\nconst min = String(kst.getMinutes()).padStart(2, '0');\nconst ss = String(kst.getSeconds()).padStart(2, '0');\n\nconst formatted = `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;\n\n// -------------------- 결과 --------------------\nreturn [{\n  json: {\n    fileName: fileName,        // \"파일명.확장자\" 형태\n    fileAddress: fileAddress,  // baseUrl 포함 전체 URL\n    creat_p_nttm: formatted,\n    created_ts: formatted,\n    content: contentRaw        // 원본 내용 그대로\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1712,1104],"id":"835fac7f-3036-4ea4-8a4a-98c79cbf25e7","name":"내용 정규화1"},{"parameters":{"rule":{"interval":[{"triggerAtHour":11,"triggerAtMinute":50}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-4000,1200],"id":"e4136948-dcf0-4640-af76-0804dd9dc9f9","name":"Schedule Trigger"},{"parameters":{"table":{"__rl":true,"value":"n8n_crawl_summary","mode":"list","cachedResultName":"n8n_crawl_summary"},"dataMode":"defineBelow","valuesToSend":{"values":[{"column":"workflow_name","value":"={{ $workflow.name }}"},{"column":"total_count","value":"={{ $json.date.length }}"},{"column":"type","value":"total_count"}]},"options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-3168,1344],"id":"b8e4c1ea-9de7-43d8-ab05-9daf7b74cab8","name":"공고상태전체개수저장","credentials":{"mySql":{"id":"s7XNBHZtTOH7C66M","name":"MySQL account 2"}}},{"parameters":{"jsCode":"// Function 노드 안\nreturn [\n  {\n    json: {\n      workflowName: $workflow.name,\n      insertId:$input.first().json.data.insertId\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-960,960],"id":"64f76798-ba2d-4c48-aadf-b48340b0bfdc","name":"공고상태정리","disabled":true},{"parameters":{"table":{"__rl":true,"value":"n8n_crawl_summary","mode":"list","cachedResultName":"n8n_crawl_summary"},"dataMode":"defineBelow","valuesToSend":{"values":[{"column":"workflow_name","value":"={{ $workflow.name }}"},{"column":"insertId","value":"={{ $json.insertId }}"},{"column":"type","value":"detail"}]},"options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-752,960],"id":"e926937d-4610-4ca0-bc03-0d2398ee7bb9","name":"공고상태상세저장","credentials":{"mySql":{"id":"s7XNBHZtTOH7C66M","name":"MySQL account 2"}},"disabled":true}],"connections":{"board list1":{"main":[[{"node":"리스트 추출1","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"중복 자료 조회1","type":"main","index":0}]]},"리스트 추출3":{"main":[[{"node":"내용 정규화1","type":"main","index":0}]]},"ai result":{"main":[[{"node":"MySQL","type":"main","index":0}]]},"MySQL":{"main":[[{"node":"Wait","type":"main","index":0},{"node":"공고상태정리","type":"main","index":0}]]},"금일 기준1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"중복 자료 조회1":{"main":[[{"node":"중복조회 MYSQL1","type":"main","index":0}]]},"중복조회 MYSQL1":{"main":[[{"node":"중복조회 IF1","type":"main","index":0}]]},"중복조회 IF1":{"main":[[{"node":"get detail","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}]]},"리스트 추출1":{"main":[[{"node":"금일 기준1","type":"main","index":0},{"node":"공고상태전체개수저장","type":"main","index":0}]]},"set cookie1":{"main":[[{"node":"get cookie1","type":"main","index":0}]]},"get detail":{"main":[[{"node":"리스트 추출3","type":"main","index":0}]]},"내용 정규화1":{"main":[[{"node":"ai result","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"board list1","type":"main","index":0}]]},"공고상태정리":{"main":[[{"node":"공고상태상세저장","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","timezone":"Asia/Seoul","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Mlhukb9mbuzpvwkH"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"42c050b7-e5ad-4ac7-94d9-c045c8613e91","triggerCount":1,"shared":[{"createdAt":"2025-09-10T04:49:01.704Z","updatedAt":"2025-09-10T04:49:01.704Z","role":"workflow:owner","workflowId":"X6gxBfOGBA3PB9Wb","projectId":"YGqg9zdxGQSC73yC"}],"tags":[]}