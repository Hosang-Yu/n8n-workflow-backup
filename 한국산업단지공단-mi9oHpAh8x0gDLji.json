{"createdAt":"2025-06-13T04:34:28.375Z","updatedAt":"2025-06-23T02:21:41.963Z","id":"mi9oHpAh8x0gDLji","name":"한국산업단지공단","active":false,"isArchived":true,"nodes":[{"parameters":{},"name":"execute","type":"n8n-nodes-base.manualTrigger","position":[-3960,-1000],"typeVersion":1,"id":"7a4d93ab-8d5e-4505-85e5-78d53a6b364a"},{"parameters":{"batchSize":1,"options":{"reset":false}},"id":"aa2bbb49-0a22-484c-a3fb-114de8d5f3a1","name":"SplitInBatches12","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[-3040,-1000]},{"parameters":{"values":{"string":[{"name":"fullUrl","value":"={{ 'https://www.kicox.or.kr' + $json.href }}"}]},"options":{}},"id":"a11c8e70-e177-425a-a4d5-cb0b66e60d7f","name":"Set Full URL6","type":"n8n-nodes-base.set","typeVersion":1,"position":[-2840,-1000]},{"parameters":{"url":"={{ $json.fullUrl }}","responseFormat":"string","options":{}},"id":"56c696e1-1bf9-4c07-afed-7cbc12d4fb35","name":"Get Detail HTML6","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[-2620,-1000]},{"parameters":{"extractionValues":{"values":[{"key":"pblanc_nm","cssSelector":"div.detail-area div.title"},{"key":"reqst_begin_end_de","cssSelector":"div.util span.date"},{"key":"bsns_sumry_cn","cssSelector":"div.txt","returnValue":"html"},{"key":"flpth_nm","cssSelector":"span.file-download-list a\t","returnValue":"attribute","attribute":"href","returnArray":true},{"key":"file_nm","cssSelector":"span.file-download-list a","returnArray":true}]},"options":{"trimValues":true}},"id":"07a5493c-182f-4ce4-957e-297c00909856","name":"Extract Content6","type":"n8n-nodes-base.htmlExtract","typeVersion":1,"position":[-2400,-1000]},{"parameters":{"jsCode":"// return $json.href.map(link => {\n//   return {\n//     json: {\n//       href: link\n//     }\n//   };\n// });\nconst links = $json.href || [];\nreturn links.map(link => ({ json: { href: link } }));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3260,-1000],"id":"97671ace-e07c-45ba-81d2-872557751120","name":"split4"},{"parameters":{"method":"POST","url":"https://api.mistral.ai/v1/files","sendHeaders":true,"headerParameters":{"parameters":[{"name":"content-type","value":"application/octet-stream"},{"name":"Authorization","value":"Bearer  aJUugk77GjvB8L7smr5n11JlKLab1xE5"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"purpose","value":"ocr"},{"parameterType":"formBinaryData","name":"=file","inputDataFieldName":"data"}]},"options":{"allowUnauthorizedCerts":false}},"id":"65793571-8cf2-4823-b134-be55e12b9c01","name":"Upload a file7","type":"n8n-nodes-base.httpRequest","position":[-1460,-1300],"typeVersion":4.2,"onError":"continueErrorOutput"},{"parameters":{"url":"=https://api.mistral.ai/v1/files/{{$json[\"id\"]}}/url","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer  aJUugk77GjvB8L7smr5n11JlKLab1xE5"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1200,-1320],"id":"914da9f7-5f41-4c7b-824e-960ec2f07ecf","name":"HTTP Request16"},{"parameters":{"method":"POST","url":"https://api.mistral.ai/v1/ocr","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer  aJUugk77GjvB8L7smr5n11JlKLab1xE5"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"mistral-ocr-latest\",\n  \"document\": {\n    \"type\": \"document_url\",\n    \"document_url\": \"{{ $json.url }}\"\n  },\n  \"include_image_base64\": true\n}","options":{"allowUnauthorizedCerts":false,"response":{"response":{"responseFormat":"json"}}}},"id":"afa8a7d8-be58-4853-9a52-e0d88392e843","name":"do ocr7","type":"n8n-nodes-base.httpRequest","position":[-980,-1320],"typeVersion":4.2},{"parameters":{"url":"={{ $json.downloadUrl }}","options":{"response":{"response":{"responseFormat":"file"}},"timeout":60000}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1980,-1240],"id":"5795533b-37e5-4f86-bd64-0bb827f01571","name":"download files5","executeOnce":false},{"parameters":{"jsCode":"// const ocrText = $json.text || $json.ocr_result || JSON.stringify($json, null, 2);\n\n// return {\n//   json: {\n//     chatInput: `다음은 공고의 첨부파일에서 OCR로 추출한 텍스트입니다. 이 텍스트를 읽고 다음 정보를 요약해 주세요.\n//   반환형식을 꼭 지켜!\n\n// 다음은 정부지원사업 공고의 OCR 텍스트입니다.  \n// 이 텍스트를 기반으로 아래 JSON 구조에 맞게 항목을 채워 주세요.\n\n// 각 key는 반드시 그대로 유지하고, 값이 없을 경우 null 또는 기본값을 사용해 주세요.  \n// (주석은 설명 용도로만 표시한 것입니다. 응답에서는 제거하고 순수 JSON으로 반환해주세요.)\n\n// json\n// {\n//   \"biz_info_id\": null,                            // (자동 생성. 입력하지 않아도 됨)\n//   \"pblanc_nm\": null,                              // 공고 제목\n//   \"pblanc_url\": null,                             // 공고 상세 URL\n//   \"pblanc_id\": null,                              // 공고 ID\n//   \"jrsd_instt_nm\": null,                          // 주관/지원 기관명 (예: 전북특별자치도)\n//   \"exc_instt_nm\": null,                           // 수행기관 (예: 직접수행, 외부수행 등)\n//   \"bsns_sumry_cn\": null,                          // 공고 요약 (HTML 혹은 일반 텍스트)\n//   \"print_flpth_nm\": null,                         // 메인 PDF 링크\n//   \"print_file_nm\": null,                          // 메인 PDF 파일명\n//   \"flpth_nm\": null,                               // 첨부파일 경로들 (@ 구분)\n//   \"file_nm\": null,                                // 첨부파일명 (zip 등)\n\n//   \"pldir_sport_realm_lclas_code_nm\": null,        // 대분류 분야명 (예: 기술, 경영 등)\n//   \"rcept_engn_hmpg_url\": null,                    // 신청처 홈페이지\n//   \"trget_nm\": null,                               // 대상기업 (예: 중소기업, 중견기업 등)\n\n//   \"reqst_begin_end_de\": null,                     // 공고 전체 기간 (예: 20240801 ~ 20240930)\n//   \"reqst_begin_dt\": null,                         // 시작일 (예: 2024-08-01)\n//   \"reqst_end_dt\": null,                           // 마감일 (예: 2024-09-30)\n//   \"reqst_mth_papers_cn\": null,                    // 신청 방법 (예: 온라인 접수 등)\n//   \"pldir_sport_realm_mlsfc_code_nm\": null,        // 중분류 분야명\n//   \"refrnc_nm\": null,                              // 문의처 (예: 전화번호 포함 문장)\n//   \"inqire_co\": 0,                                 // 문의 수 (없으면 0)\n\n//   \"creat_p_nttm\": null,                           // 공고 등록 일시\n//   \"created_ts\": null,                             // 시스템에 등록된 시간\n//   \"hash_tags\": null,                              // 키워드 (쉼표 구분)\n//   \"del_yn\": \"N\",                                   // 삭제 여부 (기본값 N)\n//   \"hide_yn\": \"Y\",                                  // 숨김 여부 (기본값 Y)\n//   \"views\": 0,                                     // 조회수 (기본값 0)\n\n//   \"is_classified\": \"N\",                           // 분류 여부 (N: 미분류)\n//   \"source\": \"한국산업단지공단\",                            // 출처 (예: 한국산업단지공단)\n//   \"main_category\": null,\n//   \"sub_category\": null,\n//   \"classified_date\": null,\n//   \"classified_by\": null,\n\n//   \"subsidy_amount\": null,                         // 정부 지원금 (예: \"140억 원\")\n//   \"self_contribution_rate\": null,                 // 자부담 비율 (예: \"40% 이상\")\n//   \"support_target\": null,                         // 지원 대상 설명\n//   \"bonus_points_factors\": null,                   // 가점 요소\n//   \"total_budget\": null,                           // 총사업비 (예: \"200억 원\")\n//   \"applicant_count\": 0,                           // 모집/선정 수 (없으면 0)\n//   \"subsidy_amount_type\": null,                    // 지원금 단위 (예: 연차별, 총액)\n//   \"total_budget_type\": null,                      // 총사업비 단위\n//   \"equipment_detail_file_path\": null,             // 장비 세부파일 경로\n//   \"equipment_detail_file_name\": null              // 장비 세부파일 이름\n// }\n\n\n// [텍스트 시작]\n// ${ocrText}\n// [텍스트 끝]`\n//   }\n// };\n\n\n\nconst fullOcrText = $json.text || $json.ocr_result || JSON.stringify($json, null, 2);\nconst truncatedOcrText = fullOcrText.slice(0, 3000); // 앞 3000자만 추출\n\nreturn {\n  json: {\n    chatInput: `다음은 공고의 첨부파일에서 OCR로 추출한 텍스트입니다. 이 텍스트를 읽고 다음 정보를 요약해 주세요.\n  반환형식을 꼭 지켜!\n\n다음은 정부지원사업 공고의 OCR 텍스트입니다.  \n이 텍스트를 기반으로 아래 JSON 구조에 맞게 항목을 채워 주세요.\n\n각 key는 반드시 그대로 유지하고, 값이 없을 경우 null 또는 기본값을 사용해 주세요.  \n(주석은 설명 용도로만 표시한 것입니다. 응답에서는 제거하고 순수 JSON으로 반환해주세요.)\n\njson\n{\n  \"biz_info_id\": null,\n  \"pblanc_nm\": null,\n  \"pblanc_url\": null,\n  \"pblanc_id\": null,\n  \"jrsd_instt_nm\": null,\n  \"exc_instt_nm\": null,\n  \"bsns_sumry_cn\": null,\n  \"print_flpth_nm\": null,\n  \"print_file_nm\": null,\n  \"flpth_nm\": null,\n  \"file_nm\": null,\n  \"pldir_sport_realm_lclas_code_nm\": null,\n  \"rcept_engn_hmpg_url\": null,\n  \"trget_nm\": null,\n  \"reqst_begin_end_de\": null,\n  \"reqst_begin_dt\": null,\n  \"reqst_end_dt\": null,\n  \"reqst_mth_papers_cn\": null,\n  \"pldir_sport_realm_mlsfc_code_nm\": null,\n  \"refrnc_nm\": null,\n  \"inqire_co\": 0,\n  \"creat_p_nttm\": null,\n  \"created_ts\": null,\n  \"hash_tags\": null,\n  \"del_yn\": \"N\",\n  \"hide_yn\": \"Y\",\n  \"views\": 0,\n  \"is_classified\": \"N\",\n  \"source\": \"기업마당\",\n  \"main_category\": null,\n  \"sub_category\": null,\n  \"classified_date\": null,\n  \"classified_by\": null,\n  \"subsidy_amount\": null,\n  \"self_contribution_rate\": null,\n  \"support_target\": null(이건 100자 이하로), \n  \"bonus_points_factors\": null,\n  \"total_budget\": null,\n  \"applicant_count\": 0,\n  \"subsidy_amount_type\": null,\n  \"total_budget_type\": null,\n  \"equipment_detail_file_path\": null,\n  \"equipment_detail_file_name\": null\n}\n\n[텍스트 시작]\n${truncatedOcrText}\n[텍스트 끝]`\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-800,-1320],"id":"28ebdc42-e486-4d4e-9f8f-fe0d022d7424","name":"Code21"},{"parameters":{"modelName":"models/gemini-1.5-flash","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-620,-1100],"id":"ce4e7859-e450-4abd-8b4c-c665478b4d02","name":"Google Gemini Chat Model6","credentials":{"googlePalmApi":{"id":"1n1ZCgSpI165zI9c","name":"Google Gemini(PaLM) Api account 3"}}},{"parameters":{"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[-640,-1320],"id":"92f791a2-63f8-4d23-960e-114f8a22434c","name":"Basic LLM Chain5"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// // Run Once for Each Item 모드에 맞춘 Code\n// const urls = Array.isArray($json.flpth_nm)\n//   ? $json.flpth_nm\n//   : String($json.flpth_nm).split('@');\n\n// // 지금 처리 중인 파일 인덱스가 있는 경우만 하나 추출\n// const index = $json.fileIndex || 0;\n// const url = urls[index];\n\n// // 없으면 아무것도 하지 않음\n// if (!url) {\n//   return {};\n// }\n\n// // 반환은 단일 객체만\n// return {\n//   json: {\n//     ...$json,\n//     downloadUrl: \"https://www.kicox.or.kr\" + url.trim(),\n//     fileIndex: index\n//   }\n// };\n\n\n\n//2번째 거\n// const urls = Array.isArray($json.flpth_nm)\n//   ? $json.flpth_nm\n//   : String($json.flpth_nm || \"\").split('@');\n\n// const index = $json.fileIndex || 0;\n// const url = urls[index];\n\n// if (!url) {\n//   return {};\n// }\n\n// return {\n//   json: {\n//     ...$json,\n//     downloadUrl: \"https://www.kicox.or.kr\" + url.trim(),\n//     fileIndex: index,\n//     originalFilePath: url.trim()\n//   }\n// };\n\n//3번째 거\nconst urls = Array.isArray($json.flpth_nm)\n  ? $json.flpth_nm\n  : String($json.flpth_nm || \"\").split('@');\n\nconst index = $json.fileIndex || 0;\nconst url = urls[index];\n\nif (!url) {\n  return {};\n}\n\nreturn {\n  json: {\n    ...$json,\n    mergeKey: index,  // 👈 병합 키 추가\n    downloadUrl: \"https://www.kicox.or.kr\" + url.trim(),\n    fileIndex: index,\n    originalFilePath: url.trim()\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2200,-1000],"id":"e2605fb3-fa01-4930-bacb-73fb5d89d869","name":"flpth_nm 분리 후 downloadUrl 생성4"},{"parameters":{"operation":"upsert","table":{"__rl":true,"value":"biz_info","mode":"list","cachedResultName":"biz_info"},"columnToMatchOn":"pblanc_nm","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.4,"position":[520,-1020],"id":"07650c95-43a0-4401-9dbf-d956333d75c8","name":"MySQL7","credentials":{"mySql":{"id":"s7XNBHZtTOH7C66M","name":"MySQL account 2"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[720,-1020],"id":"7a9daddc-166a-46cd-95df-9ef6b9114ab3","name":"No Operation, do nothing1"},{"parameters":{"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1520,-2500],"id":"9df1b88d-a053-4321-944d-a0ef5604e1f3","name":"Edit Fields"},{"parameters":{"method":"POST","url":"http://43.200.39.170:8000/convert","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1620,-1140],"id":"81caf5f7-8dbc-4e93-8e85-b0336b6cb760","name":"hwp ocr"},{"parameters":{"mode":"raw","jsonOutput":"{{ $json }}","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1400,-2220],"id":"c29a874f-e0bd-4823-8e57-16fc187bc90e","name":"Edit Fields1"},{"parameters":{"values":{"string":[{"name":"fullUrl","value":"https://www.kicox.or.kr/user/bbs/BD_selectBbs.do?q_bbsCode=1016&q_bbscttSn=20250529140728157&q_order=&q_clCode="}]},"options":{}},"id":"580701ed-9d4d-428b-b635-4d9952d8052e","name":"Set Full URL7","type":"n8n-nodes-base.set","typeVersion":1,"position":[-2700,-2040]},{"parameters":{"jsCode":"// // Gemini 또는 LLM 응답의 텍스트 내용만 추출\n// const geminiText = $json.text; // or $item(0).json.text\n\n// // Markdown 코드 블록에서 JSON 추출: ```json\\n{...}\\n```\n// const jsonMatch = geminiText.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n\n// if (!jsonMatch) {\n//   throw new Error(\"JSON block not found in Gemini output.\");\n// }\n\n// let parsed;\n// try {\n//   parsed = JSON.parse(jsonMatch[1]);\n// } catch (err) {\n//   throw new Error(\"Failed to parse JSON: \" + err.message);\n// }\n\n// // 후처리 + 경로 가공\n// return {\n//   json: {\n//     ...$json,\n//     ...parsed,\n\n//     flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? parsed.flpth_nm.map(path => \"https://www.kicox.or.kr\" + path).join(\"@\")\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     print_flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? \"https://www.kicox.or.kr\" + parsed.flpth_nm[0]\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     exc_instt_nm: parsed.exc_instt_nm || \"test\",\n//     del_yn: \"N\",\n//     creat_p_nttm: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//     created_ts: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//   }\n// };\n\n\n\n\n\n//2번째 거\n// const geminiText = $json.text;\n// const jsonMatch = geminiText.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n// if (!jsonMatch) {\n//   throw new Error(\"JSON block not found in Gemini output.\");\n// }\n\n// let parsed;\n// try {\n//   parsed = JSON.parse(jsonMatch[1]);\n// } catch (err) {\n//   throw new Error(\"Failed to parse JSON: \" + err.message);\n// }\n\n// // ✅ text 필드 제외 후 병합\n// const {\n//   text, // eslint-disable-line no-unused-vars\n//   ...rest\n// } = $json;\n\n// return {\n//   json: {\n//     ...rest,\n//     ...parsed,\n\n//     flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? parsed.flpth_nm.map(path => \"https://www.kicox.or.kr\" + path).join(\"@\")\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     print_flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? \"https://www.kicox.or.kr\" + parsed.flpth_nm[0]\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     exc_instt_nm: parsed.exc_instt_nm || \"test\",\n//     del_yn: \"N\",\n//     creat_p_nttm: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//     created_ts: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//     source: \"한국산업단지공단\"\n//   }\n// };\n\n\n\n//3번째 거\n// const geminiText = $json.text;\n// const jsonMatch = geminiText.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n// if (!jsonMatch) {\n//   throw new Error(\"JSON block not found in Gemini output.\");\n// }\n\n// let parsed;\n// try {\n//   parsed = JSON.parse(jsonMatch[1]);\n// } catch (err) {\n//   throw new Error(\"Failed to parse JSON: \" + err.message);\n// }\n\n// // text 제외\n// const { text, ...rest } = $json;\n\n// // 병합 키 유지\n// const mergeKey = $json.fileIndex || $json.mergeKey || 0;\n\n// return {\n//   json: {\n//     ...rest,\n//     ...parsed,\n//     mergeKey,  // 👈 병합 키 추가\n//     flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? parsed.flpth_nm.map(path => \"https://www.kicox.or.kr\" + path).join(\"@\")\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     print_flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? \"https://www.kicox.or.kr\" + parsed.flpth_nm[0]\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     exc_instt_nm: parsed.exc_instt_nm || \"test\",\n//     del_yn: \"N\",\n//     creat_p_nttm: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//     created_ts: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//     source: \"한국산업단지공단\"\n//   }\n// };\n\n\n\n\n\n//4번째 거\n// const geminiText = $json.text;\n// const jsonMatch = geminiText.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n// if (!jsonMatch) {\n//   throw new Error(\"JSON block not found in Gemini output.\");\n// }\n\n// // 전처리: inqire_co가 숫자형 전화번호면 문자열로 감싸기\n// let rawJson = jsonMatch[1]\n//   .replace(/\"inqire_co\"\\s*:\\s*([0-9\\-]+)\\s*,/g, '\"inqire_co\": \"$1\",');\n\n// let parsed;\n// try {\n//   parsed = JSON.parse(rawJson);\n// } catch (err) {\n//   throw new Error(\"Failed to parse JSON: \" + err.message);\n// }\n\n// // text 제외\n// const { text, ...rest } = $json;\n\n// // 병합 키 유지\n// const mergeKey = $json.fileIndex || $json.mergeKey || 0;\n\n// return {\n//   json: {\n//     ...rest,\n//     ...parsed,\n//     mergeKey,\n//     flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? parsed.flpth_nm.map(path => \"https://www.kicox.or.kr\" + path).join(\"@\")\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     print_flpth_nm: Array.isArray(parsed.flpth_nm)\n//       ? \"https://www.kicox.or.kr\" + parsed.flpth_nm[0]\n//       : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n//     exc_instt_nm: parsed.exc_instt_nm || \"test\",\n//     del_yn: \"N\",\n//     creat_p_nttm: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//     created_ts: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n//     source: \"한국산업단지공단\"\n//   }\n// };\n\n\n\n//5번째 거\nfunction convertDate(dateStr) {\n  if (!dateStr || typeof dateStr !== 'string') return null;\n  const match = dateStr.match(/(\\d{4})\\.\\s*(\\d{1,2})\\.\\s*(\\d{1,2})/);\n  if (!match) return null;\n  const [ , year, month, day ] = match;\n  return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n}\n\nconst geminiText = $json.text;\nconst jsonMatch = geminiText.match(/```json\\s*([\\s\\S]*?)\\s*```/);\nif (!jsonMatch) {\n  throw new Error(\"JSON block not found in Gemini output.\");\n}\n\n// 전화번호 문자 처리\nlet rawJson = jsonMatch[1]\n  .replace(/\"inqire_co\"\\s*:\\s*([0-9\\-]+)\\s*,/g, '\"inqire_co\": \"$1\",');\n\nlet parsed;\ntry {\n  parsed = JSON.parse(rawJson);\n} catch (err) {\n  throw new Error(\"Failed to parse JSON: \" + err.message);\n}\n\nconst { text, ...rest } = $json;\nconst mergeKey = $json.fileIndex || $json.mergeKey || 0;\n\nreturn {\n  json: {\n    ...rest,\n    ...parsed,\n    mergeKey,\n\n    // ✅ flpth_nm 변환\n    flpth_nm: Array.isArray(parsed.flpth_nm)\n      ? parsed.flpth_nm.map(path => \"https://www.kicox.or.kr\" + path).join(\"@\")\n      : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n    print_flpth_nm: Array.isArray(parsed.flpth_nm)\n      ? \"https://www.kicox.or.kr\" + parsed.flpth_nm[0]\n      : parsed.flpth_nm ? \"https://www.kicox.or.kr\" + parsed.flpth_nm : null,\n\n    // ✅ 날짜 변환\n    reqst_begin_dt: convertDate(parsed.reqst_begin_dt),\n    reqst_end_dt: convertDate(parsed.reqst_end_dt),\n\n    exc_instt_nm: parsed.exc_instt_nm,\n    del_yn: \"N\",\n    creat_p_nttm: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n    created_ts: new Date().toISOString().slice(0, 19).replace(\"T\", \" \"),\n    source: \"한국산업단지공단\"\n  }\n};\n            "},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,-1320],"id":"b65b2bab-7a5c-4fdf-83c5-073210984108","name":"ocr res"},{"parameters":{"mode":"combine","fieldsToMatchString":"mergeKey","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[20,-1020],"id":"5c6d5d16-9ed1-442a-bc24-fff165d4e861","name":"Merge"},{"parameters":{"jsCode":"//1번째 거\n// const baseUrl = \"https://www.kicox.or.kr\";\n\n// // flpth_nm이 배열이면 처리, 아니면 null\n// let updatedFlpthNm = null;\n\n// if (Array.isArray($json.flpth_nm)) {\n//   updatedFlpthNm = $json.flpth_nm\n//     .map(path => `${baseUrl}${path.trim()}`)\n//     .join(\"@\");\n// } else if (typeof $json.flpth_nm === \"string\") {\n//   // 이미 문자열인데 @로 구분된 경우\n//   updatedFlpthNm = $json.flpth_nm\n//     .split(\"@\")\n//     .map(path => `${baseUrl}${path.trim()}`)\n//     .join(\"@\");\n// }\n\n// return {\n//   json: {\n//     ...$json,\n//     flpth_nm: updatedFlpthNm\n//   }\n// };\n\n\n\n\n\n// //2..\n// const baseUrl = \"https://www.kicox.or.kr\";\n\n\n// // 1. flpth_nm 처리\n// let updatedFlpthNm = null;\n// if (Array.isArray($json.flpth_nm)) {\n//   updatedFlpthNm = $json.flpth_nm\n//     .map(path => `${baseUrl}${path.trim()}`)\n//     .join(\"@\");\n// } else if (typeof $json.flpth_nm === \"string\") {\n//   updatedFlpthNm = $json.flpth_nm\n//     .split(\"@\")\n//     .map(path => `${baseUrl}${path.trim()}`)\n//     .join(\"@\");\n// }\n\n// // 2. 필터링 대상 컬럼 (biz_info에 실제 존재하는 필드만)\n// const allowedFields = [\n//   \"biz_info_id\", \"pblanc_nm\", \"pblanc_url\", \"pblanc_id\", \"jrsd_instt_nm\",\n//   \"exc_instt_nm\", \"bsns_sumry_cn\", \"print_flpth_nm\", \"pldir_sport_realm_lclas_code_nm\",\n//   \"rcept_engn_hmpg_url\", \"trget_nm\", \"flpth_nm\", \"reqst_begin_end_de\",\n//   \"reqst_begin_dt\", \"reqst_end_dt\", \"print_file_nm\", \"reqst_mth_papers_cn\",\n//   \"pldir_sport_realm_mlsfc_code_nm\", \"refrnc_nm\", \"file_nm\", \"inqire_co\",\n//   \"creat_p_nttm\", \"created_ts\", \"hash_tags\", \"del_yn\", \"hide_yn\", \"views\",\n//   \"is_classified\", \"source\", \"main_category\", \"sub_category\", \"classified_date\",\n//   \"classified_by\", \"subsidy_amount\", \"self_contribution_rate\", \"support_target\",\n//   \"bonus_points_factors\", \"total_budget\", \"applicant_count\", \"subsidy_amount_type\",\n//   \"total_budget_type\", \"equipment_detail_file_path\", \"equipment_detail_file_name\"\n// ];\n\n// // 3. 기존 JSON에서 필요한 필드만 추출\n// const filtered = {};\n// for (const key of allowedFields) {\n//   if (key === \"flpth_nm\") {\n//     filtered[key] = updatedFlpthNm;\n//   } else if ($json.hasOwnProperty(key)) {\n//     filtered[key] = $json[key];\n//   }\n// }\n\n// return [{ json: filtered }];\n\n\n\n\n\n//3번째 거\n// const baseUrl = \"https://www.kicox.or.kr\";\n\n// // 1. flpth_nm 처리: 문자열로 변환하고, URL 붙이고, @로 연결\n// let updatedFlpthNm = null;\n// let firstPath = null;\n\n// if (Array.isArray($json.flpth_nm)) {\n//   updatedFlpthNm = $json.flpth_nm\n//     .map(path => `${baseUrl}${path.trim()}`)\n//     .join(\"@\");\n//   firstPath = `${baseUrl}${$json.flpth_nm[0].trim()}`;\n// } else if (typeof $json.flpth_nm === \"string\") {\n//   const paths = $json.flpth_nm.split(\"@\").map(p => p.trim());\n//   updatedFlpthNm = paths.map(path => `${baseUrl}${path}`).join(\"@\");\n//   if (paths.length > 0) {\n//     firstPath = `${baseUrl}${paths[0]}`;\n//   }\n// }\n\n// // 2. biz_info 테이블에 포함된 필드만 유지\n// const allowedFields = [\n//   \"pblanc_nm\", \"pblanc_url\", \"pblanc_id\", \"jrsd_instt_nm\",\n//   \"exc_instt_nm\", \"bsns_sumry_cn\", \"print_flpth_nm\", \"pldir_sport_realm_lclas_code_nm\",\n//   \"rcept_engn_hmpg_url\", \"trget_nm\", \"flpth_nm\", \"reqst_begin_end_de\",\n//   \"reqst_begin_dt\", \"reqst_end_dt\", \"print_file_nm\", \"reqst_mth_papers_cn\",\n//   \"pldir_sport_realm_mlsfc_code_nm\", \"refrnc_nm\", \"file_nm\", \"inqire_co\",\n//   \"creat_p_nttm\", \"created_ts\", \"hash_tags\", \"del_yn\", \"hide_yn\", \"views\",\n//   \"is_classified\", \"source\", \"main_category\", \"sub_category\", \"classified_date\",\n//   \"classified_by\", \"subsidy_amount\", \"self_contribution_rate\", \"support_target\",\n//   \"bonus_points_factors\", \"total_budget\", \"applicant_count\", \"subsidy_amount_type\",\n//   \"total_budget_type\", \"equipment_detail_file_path\", \"equipment_detail_file_name\"\n// ];\n\n// // 3. 필드 정리 및 적용\n// const filtered = {};\n// for (const key of allowedFields) {\n//   if (key === \"flpth_nm\") {\n//     filtered[key] = updatedFlpthNm;\n//   } else if (key === \"print_flpth_nm\") {\n//     filtered[key] = firstPath || null;\n//   } else if ($json.hasOwnProperty(key)) {\n//     filtered[key] = $json[key];\n//   }\n// }\n\n// return [{ json: filtered }];\n\n\n\n\n//4번째 거\nconst baseUrl = \"https://www.kicox.or.kr\";\n\n// flpth_nm 처리: URL 붙이고 @로 연결\nlet updatedFlpthNm = null;\nlet firstPath = null;\n\nif (Array.isArray($json.flpth_nm)) {\n  updatedFlpthNm = $json.flpth_nm.map(path => `${baseUrl}${path.trim()}`).join(\"@\");\n  firstPath = `${baseUrl}${$json.flpth_nm[0].trim()}`;\n} else if (typeof $json.flpth_nm === \"string\") {\n  const paths = $json.flpth_nm.split(\"@\").map(p => p.trim());\n  updatedFlpthNm = paths.map(path => `${baseUrl}${path}`).join(\"@\");\n  if (paths.length > 0) {\n    firstPath = `${baseUrl}${paths[0]}`;\n  }\n}\n\n// file_nm 처리: 배열이면 @로 연결, 아니면 그대로\nlet updatedFileNm = null;\nif (Array.isArray($json.file_nm)) {\n  updatedFileNm = $json.file_nm.map(name => name.trim()).join(\"@\");\n} else if (typeof $json.file_nm === \"string\") {\n  updatedFileNm = $json.file_nm.trim();\n}\n\n// biz_info 테이블 유효 필드만\nconst allowedFields = [\n  \"pblanc_nm\", \"pblanc_url\", \"pblanc_id\", \"jrsd_instt_nm\",\n  \"exc_instt_nm\", \"bsns_sumry_cn\", \"print_flpth_nm\", \"pldir_sport_realm_lclas_code_nm\",\n  \"rcept_engn_hmpg_url\", \"trget_nm\", \"flpth_nm\", \"reqst_begin_end_de\",\n  \"reqst_begin_dt\", \"reqst_end_dt\", \"print_file_nm\", \"reqst_mth_papers_cn\",\n  \"pldir_sport_realm_mlsfc_code_nm\", \"refrnc_nm\", \"file_nm\", \"inqire_co\",\n  \"creat_p_nttm\", \"created_ts\", \"hash_tags\", \"del_yn\", \"hide_yn\", \"views\",\n  \"is_classified\", \"source\", \"main_category\", \"sub_category\", \"classified_date\",\n  \"classified_by\", \"subsidy_amount\", \"self_contribution_rate\", \"support_target\",\n  \"bonus_points_factors\", \"total_budget\", \"applicant_count\", \"subsidy_amount_type\",\n  \"total_budget_type\", \"equipment_detail_file_path\", \"equipment_detail_file_name\"\n];\n\n// 필드 정리\nconst filtered = {};\nfor (const key of allowedFields) {\n  if (key === \"flpth_nm\") {\n    filtered[key] = updatedFlpthNm;\n  } else if (key === \"print_flpth_nm\") {\n    filtered[key] = firstPath || null;\n  } else if (key === \"file_nm\") {\n    filtered[key] = updatedFileNm || null;\n  } else if ($json.hasOwnProperty(key)) {\n    filtered[key] = $json[key];\n  }\n}\n\nreturn [{ json: filtered }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[260,-1020],"id":"bdc5e17c-7523-4b92-9a54-3efb583f5dd3","name":"Code"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-2500,-1500],"id":"f1cba4b8-9c5f-4bdd-8040-386b6170d0d3","name":"No Operation, do nothing"},{"parameters":{"jsCode":"const fileName = $binary?.data?.fileName || $json?.fileName || \"\";\nconst ext = fileName.toLowerCase().split('.').pop();\n\nreturn {\n  json: {\n    ...$json,\n    fileType: ext\n  },\n  binary: $binary\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1960,-2040],"id":"bf9eac54-1b1f-42af-ad5c-5e451c72b3bf","name":"is pdf"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1c0e8621-50ab-46ff-bda6-ed3fad0fbb97","leftValue":"={{$binary.data.fileExtension}}","rightValue":"pdf","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1780,-1280],"id":"abadc57a-48a5-4996-9543-66df0a06cee6","name":"If"},{"parameters":{"url":"https://www.kicox.or.kr/user/bbs/BD_selectBbsList.do?q_bbsCode=1016&currentPage=1","responseFormat":"string","options":{}},"id":"39b74c4f-6bf1-47a4-a9dc-3727b0116302","name":"리스트요청","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[-3740,-1000]},{"parameters":{"extractionValues":{"values":[{"key":"href","cssSelector":"td.subject > a","returnValue":"attribute","attribute":"href","returnArray":true}]},"options":{"trimValues":true}},"id":"137d78bb-6ae8-4f12-b70a-ee2f6358a435","name":"게시글요청","type":"n8n-nodes-base.htmlExtract","typeVersion":1,"position":[-3520,-1000]}],"connections":{"execute":{"main":[[{"node":"리스트요청","type":"main","index":0}]]},"SplitInBatches12":{"main":[[{"node":"Set Full URL6","type":"main","index":0}]]},"Get Detail HTML6":{"main":[[{"node":"Extract Content6","type":"main","index":0}]]},"Extract Content6":{"main":[[{"node":"flpth_nm 분리 후 downloadUrl 생성4","type":"main","index":0}]]},"split4":{"main":[[{"node":"SplitInBatches12","type":"main","index":0}]]},"Upload a file7":{"main":[[{"node":"HTTP Request16","type":"main","index":0}],[]]},"HTTP Request16":{"main":[[{"node":"do ocr7","type":"main","index":0}]]},"do ocr7":{"main":[[{"node":"Code21","type":"main","index":0}]]},"download files5":{"main":[[{"node":"If","type":"main","index":0}]]},"Code21":{"main":[[{"node":"Basic LLM Chain5","type":"main","index":0}]]},"Google Gemini Chat Model6":{"ai_languageModel":[[{"node":"Basic LLM Chain5","type":"ai_languageModel","index":0}]]},"Basic LLM Chain5":{"main":[[{"node":"ocr res","type":"main","index":0}]]},"flpth_nm 분리 후 downloadUrl 생성4":{"main":[[{"node":"download files5","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"MySQL7":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"No Operation, do nothing1":{"main":[[{"node":"SplitInBatches12","type":"main","index":0}]]},"Edit Fields":{"main":[[]]},"Set Full URL7":{"main":[[]]},"ocr res":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"MySQL7","type":"main","index":0}]]},"Set Full URL6":{"main":[[{"node":"Get Detail HTML6","type":"main","index":0}]]},"No Operation, do nothing":{"main":[[{"node":"SplitInBatches12","type":"main","index":0}]]},"hwp ocr":{"main":[[{"node":"Upload a file7","type":"main","index":0}]]},"is pdf":{"main":[[]]},"If":{"main":[[{"node":"Upload a file7","type":"main","index":0}],[{"node":"hwp ocr","type":"main","index":0}]]},"리스트요청":{"main":[[{"node":"게시글요청","type":"main","index":0}]]},"게시글요청":{"main":[[{"node":"split4","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"6667b293-1526-4171-9f2e-fb2c5bd0f14b","triggerCount":0,"shared":[{"createdAt":"2025-06-13T04:34:28.375Z","updatedAt":"2025-06-13T04:34:28.375Z","role":"workflow:owner","workflowId":"mi9oHpAh8x0gDLji","projectId":"FMA96HVWnRkNvN5Q"}],"tags":[]}